<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Control Financiero Personal</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/1.30.1/date_fns.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.29.0/feather.min.css">
    
    <style>
        /* ===========================================================================
   SISTEMA WEB FINANCIERO MODERNO
   Diseño inspirado en las mejores prácticas de UI/UX actuales
   Referencias: Material Design 3, Apple Human Interface Guidelines, 
   Stripe Dashboard, Linear App, Notion
   ============================================================================ */

/* CSS Variables - Sistema de Tokens de Diseño */
:root {
    /* Color Palette - Inspirado en sistemas modernos */
    --color-primary-50: #f0f9ff;
    --color-primary-100: #e0f2fe;
    --color-primary-200: #bae6fd;
    --color-primary-300: #7dd3fc;
    --color-primary-400: #38bdf8;
    --color-primary-500: #0ea5e9;
    --color-primary-600: #0284c7;
    --color-primary-700: #0369a1;
    --color-primary-800: #075985;
    --color-primary-900: #0c4a6e;
    
    --color-secondary-50: #fdf4ff;
    --color-secondary-100: #fae8ff;
    --color-secondary-200: #f5d0fe;
    --color-secondary-300: #f0abfc;
    --color-secondary-400: #e879f9;
    --color-secondary-500: #d946da;
    --color-secondary-600: #c026d3;
    --color-secondary-700: #a21caf;
    --color-secondary-800: #86198f;
    --color-secondary-900: #701a7d;

    --color-accent-50: #ecfdf5;
    --color-accent-100: #d1fae5;
    --color-accent-200: #a7f3d0;
    --color-accent-300: #6ee7b7;
    --color-accent-400: #34d399;
    --color-accent-500: #10b981;
    --color-accent-600: #059669;
    --color-accent-700: #047857;
    --color-accent-800: #065f46;
    --color-accent-900: #064e3b;

    --color-success: #28a745;
    --color-error: #dc3545;
    --color-warning: #ffc107;
    --color-info: #17a2b8;

    /* Neutral Palette - Para texto, fondos, bordes */
    --color-neutral-50: #f9fafb;
    --color-neutral-100: #f3f4f6;
    --color-neutral-200: #e5e7eb;
    --color-neutral-300: #d1d5db;
    --color-neutral-400: #9ca3af;
    --color-neutral-500: #6b7280;
    --color-neutral-600: #4b5563;
    --color-neutral-700: #374151;
    --color-neutral-800: #1f2937;
    --color-neutral-900: #111827;

    /* Typography */
    --font-family-sans: 'Inter', sans-serif;
    --font-family-mono: 'JetBrains Mono', monospace;
    --font-size-sm: 0.875rem; /* 14px */
    --font-size-base: 1rem;   /* 16px */
    --font-size-lg: 1.125rem; /* 18px */
    --font-size-xl: 1.25rem;  /* 20px */
    --font-size-2xl: 1.5rem;   /* 24px */
    --font-size-3xl: 1.875rem; /* 30px */
    --font-size-4xl: 2.25rem;  /* 36px */
    --line-height-base: 1.5;

    /* Spacing */
    --spacing-xs: 0.25rem;  /* 4px */
    --spacing-sm: 0.5rem;   /* 8px */
    --spacing-md: 1rem;     /* 16px */
    --spacing-lg: 1.5rem;   /* 24px */
    --spacing-xl: 2rem;     /* 32px */
    --spacing-2xl: 3rem;    /* 48px */

    /* Border Radii */
    --border-radius-sm: 0.25rem; /* 4px */
    --border-radius-md: 0.5rem;  /* 8px */
    --border-radius-lg: 0.75rem; /* 12px */
    --border-radius-xl: 1rem;    /* 16px */
    --border-radius-full: 9999px;

    /* Shadows */
    --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
    --shadow-2xl: 0 25px 50px -12px rgb(0 0 0 / 0.25);

    /* Transitions */
    --transition-ease-in-out: all 0.2s ease-in-out;
}

/* Base Styles */
*, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: var(--font-family-sans);
    font-size: var(--font-size-base);
    line-height: var(--line-height-base);
    color: var(--color-neutral-800);
    background-color: var(--color-neutral-100);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: var(--spacing-lg);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    overflow-x: hidden;
}

/* Main Layout Wrapper */
.main-wrapper {
    background-color: white;
    border-radius: var(--border-radius-xl);
    box-shadow: var(--shadow-2xl);
    width: 100%;
    max-width: 1300px;
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg);
    position: relative;
    overflow: hidden;
    padding: var(--spacing-xl);
}

/* Headings */
h1, h2, h3, h4, h5, h6 {
    font-weight: 700;
    line-height: 1.2;
    color: var(--color-neutral-900);
}

h1 { font-size: var(--font-size-3xl); }
h2 { font-size: var(--font-size-2xl); }
h3 { font-size: var(--font-size-xl); }

/* Buttons */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: var(--spacing-sm) var(--spacing-lg);
    border-radius: var(--border-radius-md);
    font-size: var(--font-size-base);
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition-ease-in-out);
    text-decoration: none;
    white-space: nowrap;
    border: 1px solid transparent;
}

.btn-primary {
    background-color: var(--color-primary-600);
    color: white;
    box-shadow: var(--shadow-sm);
}

.btn-primary:hover {
    background-color: var(--color-primary-700);
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
}

.btn-primary:active {
    transform: translateY(0);
    box-shadow: var(--shadow-sm);
}

.btn-secondary {
    background-color: var(--color-neutral-200);
    color: var(--color-neutral-700);
    box-shadow: var(--shadow-sm);
}

.btn-secondary:hover {
    background-color: var(--color-neutral-300);
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
}

.btn-secondary:active {
    transform: translateY(0);
    box-shadow: var(--shadow-sm);
}

.btn-outline {
    background-color: transparent;
    border-color: var(--color-primary-600);
    color: var(--color-primary-600);
    box-shadow: none;
}

.btn-outline:hover {
    background-color: var(--color-primary-50);
    color: var(--color-primary-700);
    transform: translateY(-2px);
    box-shadow: none;
}
.btn-outline:active {
    transform: translateY(0);
}

.btn-danger {
    background-color: var(--color-error);
    color: white;
}

.btn-danger:hover {
    background-color: #c82333;
    transform: translateY(-2px);
}

.btn-danger:active {
    transform: translateY(0);
}

.btn-sm {
    padding: var(--spacing-xs) var(--spacing-md);
    font-size: var(--font-size-sm);
    border-radius: var(--border-radius-sm);
}

.btn-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 38px;
    height: 38px;
    padding: 0;
    border-radius: var(--border-radius-md);
}

.btn-icon-sm {
    width: 32px;
    height: 32px;
}

.btn-icon .feather {
    width: 20px;
    height: 20px;
}

.btn-icon-sm .feather {
    width: 16px;
    height: 16px;
}

/* Forms */
.form-group {
    margin-bottom: var(--spacing-md);
}

.form-label {
    display: block;
    font-size: var(--font-size-sm);
    font-weight: 500;
    color: var(--color-neutral-700);
    margin-bottom: var(--spacing-xs);
}

.form-input,
.form-select,
.form-textarea {
    display: block;
    width: 100%;
    padding: var(--spacing-sm);
    font-size: var(--font-size-base);
    font-family: var(--font-family-sans);
    color: var(--color-neutral-800);
    background-color: white;
    border: 1px solid var(--color-neutral-300);
    border-radius: var(--border-radius-md);
    transition: var(--transition-ease-in-out);
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
    border-color: var(--color-primary-500);
    box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
    outline: none;
}

.form-textarea {
    resize: vertical;
    min-height: 80px;
}

.form-actions {
    display: flex;
    justify-content: flex-end;
    gap: var(--spacing-md);
    margin-top: var(--spacing-lg);
}

.checkbox-group {
    display: flex;
    align-items: center;
    margin-bottom: var(--spacing-md);
}

.checkbox-group input[type="checkbox"] {
    margin-right: var(--spacing-sm);
    width: 18px;
    height: 18px;
}

/* Layout Specifics */
.auth-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: calc(100vh - var(--spacing-lg) * 2);
    width: 100%;
    animation: fadeIn 0.5s ease-out forwards;
}

.auth-card {
    background-color: white;
    padding: var(--spacing-2xl);
    border-radius: var(--border-radius-xl);
    box-shadow: var(--shadow-xl);
    max-width: 450px;
    width: 100%;
    text-align: center;
}

.auth-card h2 {
    color: var(--color-primary-600);
    margin-bottom: var(--spacing-lg);
    font-size: var(--font-size-2xl);
}

.app-container {
    display: none; /* Controlled by JS */
    flex-direction: column;
    gap: var(--spacing-lg);
    width: 100%;
}

.app-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: var(--spacing-lg);
    border-bottom: 1px solid var(--color-neutral-200);
}

.app-header h1 {
    color: var(--color-primary-600);
    font-size: var(--font-size-3xl);
}

.nav-tabs {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-lg);
    border-bottom: 2px solid var(--color-neutral-100);
    padding-bottom: var(--spacing-xs);
}

.tab-button {
    background-color: transparent;
    color: var(--color-neutral-600);
    padding: var(--spacing-sm) var(--spacing-md);
    border: none;
    border-bottom: 3px solid transparent;
    font-size: var(--font-size-base);
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition-ease-in-out);
    white-space: nowrap;
}

.tab-button:hover {
    color: var(--color-primary-700);
    border-bottom-color: var(--color-primary-200);
}

.tab-button.active {
    color: var(--color-primary-600);
    border-bottom-color: var(--color-primary-600);
    font-weight: 600;
}

.tab-content {
    display: none;
    padding-top: var(--spacing-md);
    animation: fadeIn 0.4s ease-out forwards;
}

.tab-content.active {
    display: block;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-lg);
    flex-wrap: wrap;
    gap: var(--spacing-sm);
}

.section-header h2 {
    color: var(--color-neutral-800);
    font-size: var(--font-size-2xl);
}

/* Dashboard Cards */
.stat-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-lg);
}

.stat-card {
    background-color: white;
    padding: var(--spacing-lg);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-md);
    text-align: center;
    transition: transform 0.2s ease;
    border: 1px solid var(--color-neutral-200);
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
}

.stat-card h3 {
    color: var(--color-neutral-600);
    margin-bottom: var(--spacing-xs);
    font-size: var(--font-size-lg);
    font-weight: 500;
}

.stat-card p {
    font-size: var(--font-size-3xl);
    font-weight: 700;
    word-break: break-all;
    margin-top: var(--spacing-xs);
}

/* Charts */
.chart-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: var(--spacing-lg);
    margin-top: var(--spacing-lg);
}

.chart-card {
    background-color: white;
    padding: var(--spacing-lg);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-md);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--color-neutral-200);
}

.chart-card h3 {
    margin-bottom: var(--spacing-lg);
    color: var(--color-neutral-800);
    text-align: center;
    width: 100%;
    font-size: var(--font-size-xl);
}

.chart-canvas {
    width: 100% !important;
    height: 300px !important; /* Fixed height for consistency */
}

/* Filters */
.filters-container {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
    padding: var(--spacing-md);
    background-color: var(--color-neutral-50);
    border-radius: var(--border-radius-md);
    border: 1px solid var(--color-neutral-200);
    box-shadow: var(--shadow-sm);
    align-items: flex-end;
}

.filters-container .form-group {
    flex: 1 1 auto;
    min-width: 150px;
    margin-bottom: 0; /* Override default form-group margin */
}

.filters-container button {
    flex-shrink: 0;
    min-width: 120px;
}

/* Table Styles */
.table-container {
    overflow-x: auto;
    margin-top: var(--spacing-lg);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-md);
    background-color: white;
    border: 1px solid var(--color-neutral-200);
}

.data-table {
    width: 100%;
    min-width: 700px;
    border-collapse: collapse;
}

.data-table th,
.data-table td {
    padding: var(--spacing-md) var(--spacing-lg);
    text-align: left;
    white-space: nowrap;
    border-bottom: 1px solid var(--color-neutral-200);
}

.data-table th {
    background-color: var(--color-neutral-50);
    color: var(--color-neutral-600);
    font-weight: 600;
    font-size: var(--font-size-sm);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    position: sticky;
    top: 0;
    z-index: 1;
}

.data-table tbody tr:last-child td {
    border-bottom: none;
}

.data-table tbody tr:hover {
    background-color: var(--color-primary-50);
}

.table-actions {
    display: flex;
    gap: var(--spacing-xs);
}

.table-actions .btn {
    padding: var(--spacing-xs) var(--spacing-sm);
    font-size: var(--font-size-sm);
}

/* Status/Type Badges */
.status-badge {
    padding: var(--spacing-xs) var(--spacing-sm);
    border-radius: var(--border-radius-full);
    font-size: 0.75rem; /* 12px */
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    line-height: 1;
}

.status-badge.income {
    background-color: var(--color-accent-100);
    color: var(--color-accent-700);
}

.status-badge.expense {
    background-color: #fee2e2; /* Red-100 */
    color: #dc2626; /* Red-600 */
}

.text-income {
    color: var(--color-accent-600);
    font-weight: 600;
}

.text-expense {
    color: var(--color-error);
    font-weight: 600;
}

/* Modals */
.modal-overlay {
    display: none; /* Controlled by JS */
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    animation: fadeIn 0.3s ease-out forwards;
}

.modal-overlay.is-visible {
    display: flex; /* Only show when this class is active */
}

.modal-content {
    background-color: white;
    padding: var(--spacing-xl);
    border-radius: var(--border-radius-xl);
    box-shadow: var(--shadow-2xl);
    width: 90%;
    max-width: 600px;
    position: relative;
    transform: translateY(20px);
    opacity: 0;
    animation: slideInUp 0.3s ease-out 0.1s forwards;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-lg);
    padding-bottom: var(--spacing-sm);
    border-bottom: 1px solid var(--color-neutral-200);
}

.modal-header h2 {
    font-size: var(--font-size-2xl);
    color: var(--color-primary-600);
}

.modal-close-button {
    background: none;
    border: none;
    font-size: var(--font-size-2xl);
    color: var(--color-neutral-500);
    cursor: pointer;
    transition: var(--transition-ease-in-out);
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-close-button:hover {
    color: var(--color-error);
    transform: rotate(90deg);
}

/* Toast Notifications */
.toast-container {
    position: fixed;
    bottom: var(--spacing-xl);
    left: 50%;
    transform: translateX(-50%);
    z-index: 1050;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--spacing-sm);
}

.toast-message {
    background-color: var(--color-neutral-800);
    color: white;
    padding: var(--spacing-md) var(--spacing-lg);
    border-radius: var(--border-radius-md);
    box-shadow: var(--shadow-lg);
    font-size: var(--font-size-base);
    opacity: 0;
    visibility: hidden;
    transform: translateY(20px);
    transition: all 0.4s ease-out;
    min-width: 250px;
    text-align: center;
}

.toast-message.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.toast-message.success { background-color: var(--color-success); }
.toast-message.error { background-color: var(--color-error); }
.toast-message.info { background-color: var(--color-info); }
.toast-message.warning { background-color: var(--color-warning); }


/* Loading Overlay */
.loading-overlay {
    display: none; /* Controlled by JS */
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.85);
    z-index: 1100;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    gap: var(--spacing-lg);
    animation: fadeIn 0.3s ease-out forwards;
}

.loader {
    border: 6px solid var(--color-neutral-200);
    border-top: 6px solid var(--color-primary-600);
    border-radius: var(--border-radius-full);
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
}

.loader-text {
    color: var(--color-primary-700);
    font-size: var(--font-size-lg);
    font-weight: 500;
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideInUp {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Utility Classes */
.text-center { text-align: center; }
.text-right { text-align: right; }
.my-md { margin-top: var(--spacing-md); margin-bottom: var(--spacing-md); }
.mt-lg { margin-top: var(--spacing-lg); }

/* Responsive Adjustments */
@media (max-width: 768px) {
    body {
        padding: var(--spacing-md);
    }
    .main-wrapper {
        padding: var(--spacing-lg);
        gap: var(--spacing-md);
    }
    .app-header {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--spacing-sm);
    }
    .app-header h1 {
        font-size: var(--font-size-2xl);
    }
    .nav-tabs {
        flex-direction: column;
        gap: var(--spacing-xs);
    }
    .tab-button {
        width: 100%;
        text-align: left;
    }
    .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--spacing-sm);
    }
    .section-header h2 {
        font-size: var(--font-size-xl);
    }
    .stat-cards-grid {
        grid-template-columns: 1fr;
    }
    .filters-container {
        flex-direction: column;
        align-items: stretch;
    }
    .filters-container .form-group {
        min-width: unset;
        width: 100%;
    }
    .filters-container button {
        width: 100%;
    }
    .data-table th, .data-table td {
        padding: var(--spacing-sm);
        font-size: var(--font-size-sm);
    }
    .modal-content {
        padding: var(--spacing-lg);
    }
    .modal-header h2 {
        font-size: var(--font-size-xl);
    }
}

/* Print Styles */
@media print {
    .app-header, .nav-tabs, .filters-container, .modal-overlay, .toast-container, .loading-overlay {
        display: none !important;
    }
    .main-wrapper {
        box-shadow: none;
        border: none;
    }
    .stat-card, .chart-card, .table-container {
        break-inside: avoid;
        box-shadow: none;
        border: 1px solid var(--color-neutral-300);
    }
}

/* High Contrast Mode */
@media (prefers-contrast: high) {
    :root {
        --color-primary-500: #0066cc;
        --color-secondary-500: #8800cc;
        --color-neutral-900: #000000;
        --color-neutral-100: #ffffff;
        --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.3);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.3);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.3);
    }
    .btn-primary {
        background-color: var(--color-primary-500);
        border-color: var(--color-primary-500);
    }
    .btn-primary:hover {
        background-color: var(--color-primary-500);
        filter: brightness(1.2);
    }
    .btn-outline {
        border-color: var(--color-primary-500);
        color: var(--color-primary-500);
    }
    .btn-outline:hover {
        background-color: var(--color-primary-500);
        color: white;
    }
    .tab-button.active {
        border-bottom-color: var(--color-primary-500);
        color: var(--color-primary-500);
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus {
        border-color: var(--color-primary-500);
        box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.4);
    }
}
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading-overlay">
        <div class="loader"></div>
        <p class="loader-text">Cargando...</p>
    </div>

    <div class="main-wrapper">
        <section class="auth-container" id="login-section">
            <div class="auth-card">
                <h2>Iniciar Sesión</h2>
                <form id="login-form">
                    <div class="form-group">
                        <label for="username" class="form-label">Usuario:</label>
                        <input type="text" id="username" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="password" class="form-label">Contraseña:</label>
                        <input type="password" id="password" class="form-input" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Entrar</button>
                </form>
            </div>
        </section>

        <section class="app-container" id="app-section">
            <header class="app-header">
                <h1>Control Financiero</h1>
                <button id="logout-button" class="btn btn-outline">
                    <i data-feather="log-out"></i> Cerrar Sesión
                </button>
            </header>

            <nav class="nav-tabs">
                <button class="tab-button active" data-tab="dashboard">
                    <i data-feather="grid"></i> Dashboard
                </button>
                <button class="tab-button" data-tab="transactions">
                    <i data-feather="list"></i> Movimientos
                </button>
                <button class="tab-button" data-tab="add-transaction">
                    <i data-feather="plus-circle"></i> Nueva Transacción
                </button>
                <button class="tab-button" data-tab="predefined-types">
                    <i data-feather="settings"></i> Tipos Predefinidos
                </button>
            </nav>

            <div id="dashboard-tab" class="tab-content active">
                <div class="section-header">
                    <h2>Resumen Financiero <span id="dashboard-period"></span></h2>
                </div>

                <div class="filters-container">
                    <div class="form-group">
                        <label for="dashboard-month-select" class="form-label">Mes:</label>
                        <select id="dashboard-month-select" class="form-select">
                            <option value="1">Enero</option>
                            <option value="2">Febrero</option>
                            <option value="3">Marzo</option>
                            <option value="4">Abril</option>
                            <option value="5">Mayo</option>
                            <option value="6">Junio</option>
                            <option value="7">Julio</option>
                            <option value="8">Agosto</option>
                            <option value="9">Septiembre</option>
                            <option value="10">Octubre</option>
                            <option value="11">Noviembre</option>
                            <option value="12">Diciembre</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="dashboard-year-select" class="form-label">Año:</label>
                        <select id="dashboard-year-select" class="form-select"></select>
                    </div>
                </div>

                <div class="stat-cards-grid">
                    <div class="stat-card">
                        <h3 id="card-income-title">Total Ingresos</h3>
                        <p id="total-income-month">$0.00</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="card-expense-title">Total Gastos</h3>
                        <p id="total-expense-month">$0.00</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="card-balance-title">Balance</h3>
                        <p id="balance-month">$0.00</p>
                    </div>
                </div>

                <div class="chart-grid">
                    <div class="chart-card">
                        <h3>Ingresos vs Gastos</h3>
                        <canvas id="income-expense-chart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>Gastos por Categoría</h3>
                        <canvas id="expense-category-chart" class="chart-canvas"></canvas>
                    </div>
                </div>
            </div>

            <div id="transactions-tab" class="tab-content">
                <div class="section-header">
                    <h2>Historial de Movimientos</h2>
                    <button class="btn btn-primary" id="add-transaction-button-table">
                        <i data-feather="plus"></i> Añadir Transacción
                    </button>
                </div>
                
                <div class="filters-container">
                    <div class="form-group">
                        <label for="filter-month-select" class="form-label">Mes:</label>
                        <select id="filter-month-select" class="form-select"></select>
                    </div>
                    <div class="form-group">
                        <label for="filter-type-select" class="form-label">Tipo:</label>
                        <select id="filter-type-select" class="form-select">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filter-movement-select" class="form-label">Movimiento:</label>
                        <select id="filter-movement-select" class="form-select">
                            <option value="">Todos</option>
                            <option value="Ingreso">Ingreso</option>
                            <option value="Gasto">Gasto</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filter-keywords-input" class="form-label">Buscar:</label>
                        <input type="text" id="filter-keywords-input" class="form-input" placeholder="Descripción o Monto">
                    </div>
                    <button class="btn btn-secondary" id="apply-filters-button">
                        <i data-feather="filter"></i> Aplicar Filtros
                    </button>
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Movimiento</th>
                                <th>Tipo</th>
                                <th>Descripción</th>
                                <th>Monto</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-table-body">
                            </tbody>
                    </table>
                </div>
                <div id="no-transactions-message" class="text-center my-md" style="display: none;">
                    No hay transacciones para mostrar con los filtros aplicados.
                </div>
            </div>

            <div id="add-transaction-tab" class="tab-content">
                <div class="section-header">
                    <h2>Registrar Nueva Transacción</h2>
                </div>
                <form id="add-transaction-form">
                    <div class="form-group">
                        <label for="transaction-date" class="form-label">Fecha:</label>
                        <input type="date" id="transaction-date" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="transaction-movement" class="form-label">Movimiento:</label>
                        <select id="transaction-movement" class="form-select" required>
                            <option value="">Seleccione...</option>
                            <option value="Ingreso">Ingreso</option>
                            <option value="Gasto">Gasto</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="transaction-type" class="form-label">Tipo:</label>
                        <select id="transaction-type" class="form-select" required>
                            <option value="">Seleccione movimiento primero...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="transaction-description" class="form-label">Descripción:</label>
                        <input type="text" id="transaction-description" class="form-input" placeholder="Ej. Alquiler, Salario, Comida">
                    </div>
                    <div class="form-group">
                        <label for="transaction-amount" class="form-label">Monto:</label>
                        <input type="number" id="transaction-amount" class="form-input" step="0.01" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i data-feather="save"></i> Guardar Transacción
                        </button>
                    </div>
                </form>
            </div>

            <div id="predefined-types-tab" class="tab-content">
                <div class="section-header">
                    <h2>Tipos Predefinidos</h2>
                    <button class="btn btn-primary" id="add-predefined-button">
                        <i data-feather="plus"></i> Añadir Tipo
                    </button>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Movimiento</th>
                                <th>Tipo</th>
                                <th>Descripción Sugerida</th>
                                <th>Monto Sugerido</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="predefined-types-table-body">
                            </tbody>
                    </table>
                </div>
                <div id="no-predefined-types-message" class="text-center my-md" style="display: none;">
                    No hay tipos predefinidos para mostrar.
                </div>
            </div>
        </section>
    </div>

    <div id="edit-transaction-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Editar Transacción</h2>
                <button class="modal-close-button" data-modal-target="edit-transaction-modal">
                    <i data-feather="x"></i>
                </button>
            </div>
            <form id="edit-transaction-form">
                <input type="hidden" id="edit-transaction-id">
                <div class="form-group">
                    <label for="edit-transaction-date" class="form-label">Fecha:</label>
                    <input type="date" id="edit-transaction-date" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="edit-transaction-movement" class="form-label">Movimiento:</label>
                    <select id="edit-transaction-movement" class="form-select" required>
                        <option value="Ingreso">Ingreso</option>
                        <option value="Gasto">Gasto</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-transaction-type" class="form-label">Tipo:</label>
                    <input type="text" id="edit-transaction-type" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="edit-transaction-description" class="form-label">Descripción:</label>
                    <input type="text" id="edit-transaction-description" class="form-input">
                </div>
                <div class="form-group">
                    <label for="edit-transaction-amount" class="form-label">Monto:</label>
                    <input type="number" id="edit-transaction-amount" class="form-input" step="0.01" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" data-modal-target="edit-transaction-modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <div id="add-predefined-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Añadir Tipo Predefinido</h2>
                <button class="modal-close-button" data-modal-target="add-predefined-modal">
                    <i data-feather="x"></i>
                </button>
            </div>
            <form id="add-predefined-form">
                <div class="form-group">
                    <label for="add-predefined-movement" class="form-label">Movimiento:</label>
                    <select id="add-predefined-movement" class="form-select" required>
                        <option value="">Seleccione...</option>
                        <option value="Ingreso">Ingreso</option>
                        <option value="Gasto">Gasto</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="add-predefined-type" class="form-label">Tipo:</label>
                    <input type="text" id="add-predefined-type" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="add-predefined-description" class="form-label">Descripción Sugerida:</label>
                    <input type="text" id="add-predefined-description" class="form-input">
                </div>
                <div class="form-group">
                    <label for="add-predefined-amount" class="form-label">Monto Sugerido:</label>
                    <input type="number" id="add-predefined-amount" class="form-input" step="0.01">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" data-modal-target="add-predefined-modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Tipo</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-predefined-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Editar Tipo Predefinido</h2>
                <button class="modal-close-button" data-modal-target="edit-predefined-modal">
                    <i data-feather="x"></i>
                </button>
            </div>
            <form id="edit-predefined-form">
                <input type="hidden" id="edit-predefined-original-type">
                <input type="hidden" id="edit-predefined-original-movement">
                <div class="form-group">
                    <label for="edit-predefined-movement" class="form-label">Movimiento:</label>
                    <select id="edit-predefined-movement" class="form-select" required>
                        <option value="Ingreso">Ingreso</option>
                        <option value="Gasto">Gasto</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-predefined-type" class="form-label">Tipo:</label>
                    <input type="text" id="edit-predefined-type" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="edit-predefined-description" class="form-label">Descripción Sugerida:</label>
                    <input type="text" id="edit-predefined-description" class="form-input">
                </div>
                <div class="form-group">
                    <label for="edit-predefined-amount" class="form-label">Monto Sugerido:</label>
                    <input type="number" id="edit-predefined-amount" class="form-input" step="0.01">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" data-modal-target="edit-predefined-modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast-container" class="toast-container"></div>

    <script>
        // Registrar el plugin datalabels globalmente
        Chart.register(ChartDataLabels);

        // --- Constantes y Elementos del DOM ---
        // ¡IMPORTANTE! Reemplaza esta URL con la de tu Web App de Google Apps Script DESPUÉS DE DESPLEGARLA
        // La URL debe terminar en /exec
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbymBcf4ut-aL3DJshdpiO5t3UEEJiIT8PmWVPYqSIl_-nW8PST_BoZVmHVV2vlZsBM36w/exec';

        // Secciones principales
        const loginSection = document.getElementById('login-section');
        const appSection = document.getElementById('app-section');
        const loadingOverlay = document.getElementById('loading-overlay'); // Loader

        // Formularios y botones de login
        const loginForm = document.getElementById('login-form');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const logoutButton = document.getElementById('logout-button');

        // Elementos del Dashboard
        const dashboardMonthSelect = document.getElementById('dashboard-month-select');
        const dashboardYearSelect = document.getElementById('dashboard-year-select');
        const dashboardPeriodSpan = document.getElementById('dashboard-period');
        const cardIncomeTitle = document.getElementById('card-income-title');
        const cardExpenseTitle = document.getElementById('card-expense-title');
        const cardBalanceTitle = document.getElementById('card-balance-title');
        const totalIncomeMonth = document.getElementById('total-income-month');
        const totalExpenseMonth = document.getElementById('total-expense-month');
        const balanceMonth = document.getElementById('balance-month');
        const incomeExpenseChartCanvas = document.getElementById('income-expense-chart');
        const expenseCategoryChartCanvas = document.getElementById('expense-category-chart');

        let incomeExpenseChart;
        let expenseCategoryChart;

        // Elementos de Navegación
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        // Elementos de Transacciones
        const addTransactionButtonTable = document.getElementById('add-transaction-button-table');
        const transactionsTableBody = document.getElementById('transactions-table-body');
        const noTransactionsMessage = document.getElementById('no-transactions-message');
        const filterMonthSelect = document.getElementById('filter-month-select');
        const filterTypeSelect = document.getElementById('filter-type-select');
        const filterMovementSelect = document.getElementById('filter-movement-select');
        const filterKeywordsInput = document.getElementById('filter-keywords-input');
        const applyFiltersButton = document.getElementById('apply-filters-button');

        // Elementos de Añadir Transacción
        const addTransactionForm = document.getElementById('add-transaction-form');
        const transactionDateInput = document.getElementById('transaction-date');
        const transactionMovementSelect = document.getElementById('transaction-movement');
        const transactionTypeSelect = document.getElementById('transaction-type');
        const transactionDescriptionInput = document.getElementById('transaction-description');
        const transactionAmountInput = document.getElementById('transaction-amount');

        // Elementos de Tipos Predefinidos
        const predefinedTypesTableBody = document.getElementById('predefined-types-table-body');
        const noPredefinedTypesMessage = document.getElementById('no-predefined-types-message');
        const addPredefinedButton = document.getElementById('add-predefined-button');

        // Modales
        const editTransactionModal = document.getElementById('edit-transaction-modal');
        const editTransactionForm = document.getElementById('edit-transaction-form');
        const addPredefinedModal = document.getElementById('add-predefined-modal');
        const addPredefinedForm = document.getElementById('add-predefined-form');
        const editPredefinedModal = document.getElementById('edit-predefined-modal');
        const editPredefinedForm = document.getElementById('edit-predefined-form');

        // Elementos del Toast
        const toastContainer = document.getElementById('toast-container');

        // Variables para almacenar datos (cache)
        let allTransactions = [];
        let allPredefinedTypes = [];
        let currentFilters = {
            month: new Date().getMonth() + 1,
            year: new Date().getFullYear(),
            type: '',
            movement: '',
            keywords: ''
        };

        // --- Funciones de Utilidad ---

        function showLoading() {
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.classList.add('toast-message', type);
            toast.textContent = message;
            toastContainer.appendChild(toast);

            // Trigger reflow to enable transition
            void toast.offsetWidth; 
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            date.setDate(date.getDate() + 1); // Fix for timezone offset
            return date.toLocaleDateString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit' });
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(amount);
        }

        function openModal(modalElement) {
            modalElement.classList.add('is-visible');
        }

        function closeModal(modalElement) {
            modalElement.classList.remove('is-visible');
        }

        // --- Manejo de Pestañas ---

        function activateTab(tabName) {
            tabButtons.forEach(button => {
                if (button.dataset.tab === tabName) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });

            tabContents.forEach(content => {
                if (content.id === `${tabName}-tab`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });

            // Acciones específicas al cambiar de pestaña
            if (tabName === 'dashboard') {
                updateDashboard();
            } else if (tabName === 'transactions') {
                loadTransactions();
            } else if (tabName === 'predefined-types') {
                loadPredefinedTypes();
            } else if (tabName === 'add-transaction') {
                loadPredefinedTypesForTransactionForm();
            }
        }

        // --- Comunicación con Google Apps Script ---

        async function fetchData(action, params = {}) {
            showLoading();
            try {
                const queryParams = new URLSearchParams({ action, ...params }).toString();
                const response = await fetch(`${WEB_APP_URL}?${queryParams}`);
                const data = await response.json();
                if (data.status === 'error') {
                    showToast(data.message, 'error');
                    console.error('Backend error:', data.message);
                }
                return data;
            } catch (error) {
                showToast('Error de conexión con el servidor.', 'error');
                console.error('Fetch error:', error);
                return { status: 'error', message: `Client-side fetch error: ${error.message}` };
            } finally {
                hideLoading();
            }
        }

        async function postData(action, payload = {}) {
            showLoading();
            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors', // Asegúrate de que CORS esté habilitado en el lado de Apps Script
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({ action, data: JSON.stringify(payload) }).toString(),
                });
                const data = await response.json();
                if (data.status === 'error') {
                    showToast(data.message, 'error');
                    console.error('Backend error:', data.message);
                }
                return data;
            } catch (error) {
                showToast('Error de conexión con el servidor.', 'error');
                console.error('Post error:', error);
                return { status: 'error', message: `Client-side post error: ${error.message}` };
            } finally {
                hideLoading();
            }
        }

        // --- Autenticación ---

        async function handleLogin(event) {
            event.preventDefault();
            const username = usernameInput.value;
            const password = passwordInput.value;

            const result = await postData('login', { username, password });

            if (result.status === 'success') {
                showToast('Inicio de sesión exitoso.', 'success');
                loginSection.style.display = 'none';
                appSection.style.display = 'flex';
                feather.replace(); // Initialize feather icons
                initializeDashboardFilters();
                updateDashboard();
                loadPredefinedTypesForTransactionForm(); // Load types initially
            } else {
                showToast('Credenciales incorrectas.', 'error');
            }
        }

        function handleLogout() {
            // En una aplicación real, aquí limpiarías tokens/sesiones
            showToast('Sesión cerrada.', 'info');
            appSection.style.display = 'none';
            loginSection.style.display = 'flex';
            usernameInput.value = '';
            passwordInput.value = '';
        }

        // --- Dashboard ---

        function initializeDashboardFilters() {
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1;

            // Populate year select
            dashboardYearSelect.innerHTML = '';
            for (let i = currentYear - 5; i <= currentYear + 5; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                if (i === currentYear) {
                    option.selected = true;
                }
                dashboardYearSelect.appendChild(option);
            }

            // Set current month
            dashboardMonthSelect.value = currentMonth;
        }

        async function updateDashboard() {
            const month = dashboardMonthSelect.value;
            const year = dashboardYearSelect.value;
            currentFilters.month = parseInt(month); // Update global filter state
            currentFilters.year = parseInt(year);

            const monthName = new Date(year, month - 1, 1).toLocaleDateString('es-ES', { month: 'long' });
            dashboardPeriodSpan.textContent = `(${monthName} de ${year})`;

            const data = await fetchData('getDashboardData', { month, year });

            if (data.status === 'success') {
                totalIncomeMonth.textContent = formatCurrency(data.totalIncome);
                totalExpenseMonth.textContent = formatCurrency(data.totalExpense);
                balanceMonth.textContent = formatCurrency(data.balance);

                // Update chart titles for consistency (optional, but good UX)
                cardIncomeTitle.textContent = `Total Ingresos (${monthName})`;
                cardExpenseTitle.textContent = `Total Gastos (${monthName})`;
                cardBalanceTitle.textContent = `Balance (${monthName})`;

                renderIncomeExpenseChart(data.totalIncome, data.totalExpense);
                renderExpenseCategoryChart(data.expenseByCategory);
            }
        }

        function renderIncomeExpenseChart(income, expense) {
            const ctx = incomeExpenseChartCanvas.getContext('2d');
            if (incomeExpenseChart) {
                incomeExpenseChart.destroy();
            }
            incomeExpenseChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Ingresos', 'Gastos'],
                    datasets: [{
                        data: [income, expense],
                        backgroundColor: [
                            'var(--color-accent-500)', // Income
                            'var(--color-error)'       // Expense
                        ],
                        borderColor: [
                            'var(--color-accent-600)',
                            '#a71d2a'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return formatCurrency(context.raw);
                                }
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: function(value) {
                                return formatCurrency(value);
                            },
                            color: 'var(--color-neutral-800)',
                            font: {
                                weight: 'bold'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderExpenseCategoryChart(expenseByCategory) {
            const ctx = expenseCategoryChartCanvas.getContext('2d');
            if (expenseCategoryChart) {
                expenseCategoryChart.destroy();
            }

            const labels = expenseByCategory.map(item => item.type);
            const data = expenseByCategory.map(item => item.total);
            const backgroundColors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40',
                '#E7E9ED', '#8B008B', '#228B22', '#FFDAB9'
            ]; // More colors as needed

            expenseCategoryChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors.slice(0, labels.length),
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += formatCurrency(context.raw);
                                    return label;
                                }
                            }
                        },
                        datalabels: {
                            color: '#fff',
                            formatter: (value, context) => {
                                const total = context.dataset.data.reduce((acc, val) => acc + val, 0);
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%';
                                return percentage;
                            },
                            font: {
                                weight: 'bold',
                                size: 10
                            }
                        }
                    }
                }
            });
        }

        // --- Transacciones ---

        async function loadTransactions() {
            const data = await fetchData('getTransactions');
            if (data.status === 'success') {
                allTransactions = data.transactions;
                populateFilterMonths();
                applyFilters(); // Apply initial filters based on currentFilters state
            }
        }

        function populateFilterMonths() {
            // Populate month filter based on available transaction dates
            const years = new Set(allTransactions.map(t => new Date(t.Fecha).getFullYear()));
            const months = new Set();
            allTransactions.forEach(t => {
                const date = new Date(t.Fecha);
                months.add(`${date.getFullYear()}-${date.getMonth() + 1}`);
            });

            // Clear existing options, but keep "Todos"
            filterMonthSelect.innerHTML = '<option value="">Todos</option>';
            // Sort months to display chronologically
            const sortedMonths = Array.from(months).sort((a, b) => {
                const [yearA, monthA] = a.split('-').map(Number);
                const [yearB, monthB] = b.split('-').map(Number);
                if (yearA !== yearB) return yearA - yearB;
                return monthA - monthB;
            });

            sortedMonths.forEach(monthYear => {
                const [year, month] = monthYear.split('-');
                const date = new Date(year, month - 1, 1);
                const option = document.createElement('option');
                option.value = monthYear; // e.g., "2023-1"
                option.textContent = date.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                filterMonthSelect.appendChild(option);
            });
            filterMonthSelect.value = `${currentFilters.year}-${currentFilters.month}`; // Set current dashboard month/year
        }

        function applyFilters() {
            const selectedMonthYear = filterMonthSelect.value;
            const selectedType = filterTypeSelect.value;
            const selectedMovement = filterMovementSelect.value;
            const keywords = filterKeywordsInput.value.toLowerCase();

            // Update currentFilters
            currentFilters.type = selectedType;
            currentFilters.movement = selectedMovement;
            currentFilters.keywords = keywords;

            if (selectedMonthYear) {
                const [year, month] = selectedMonthYear.split('-').map(Number);
                currentFilters.month = month;
                currentFilters.year = year;
            } else {
                currentFilters.month = '';
                currentFilters.year = '';
            }

            const filteredTransactions = allTransactions.filter(transaction => {
                const transactionDate = new Date(transaction.Fecha);
                const matchMonth = !currentFilters.month || 
                                   (transactionDate.getMonth() + 1 === currentFilters.month && 
                                    transactionDate.getFullYear() === currentFilters.year);
                const matchType = !selectedType || transaction.Tipo === selectedType;
                const matchMovement = !selectedMovement || transaction.Movimiento === selectedMovement;
                const matchKeywords = !keywords || 
                                    transaction.Descripcion.toLowerCase().includes(keywords) ||
                                    transaction.Monto.toString().includes(keywords);
                return matchMonth && matchType && matchMovement && matchKeywords;
            });

            renderTransactionsTable(filteredTransactions);
        }

        function renderTransactionsTable(transactions) {
            transactionsTableBody.innerHTML = '';
            if (transactions.length === 0) {
                noTransactionsMessage.style.display = 'block';
                return;
            }
            noTransactionsMessage.style.display = 'none';

            transactions.forEach(transaction => {
                const row = transactionsTableBody.insertRow();
                row.insertCell().textContent = formatDate(transaction.Fecha);
                const movementCell = row.insertCell();
                movementCell.innerHTML = `<span class="status-badge ${transaction.Movimiento === 'Ingreso' ? 'income' : 'expense'}">${transaction.Movimiento}</span>`;
                row.insertCell().textContent = transaction.Tipo;
                row.insertCell().textContent = transaction.Descripcion;
                const amountCell = row.insertCell();
                amountCell.textContent = formatCurrency(transaction.Monto);
                amountCell.classList.add(transaction.Movimiento === 'Ingreso' ? 'text-income' : 'text-expense');

                const actionsCell = row.insertCell();
                actionsCell.classList.add('table-actions');
                
                const editButton = document.createElement('button');
                editButton.innerHTML = '<i data-feather="edit-2"></i>';
                editButton.classList.add('btn', 'btn-secondary', 'btn-icon', 'btn-icon-sm');
                editButton.title = 'Editar';
                editButton.addEventListener('click', () => openEditTransactionModal(transaction));
                actionsCell.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.innerHTML = '<i data-feather="trash-2"></i>';
                deleteButton.classList.add('btn', 'btn-danger', 'btn-icon', 'btn-icon-sm');
                deleteButton.title = 'Eliminar';
                deleteButton.addEventListener('click', () => deleteTransaction(transaction.ID));
                actionsCell.appendChild(deleteButton);
            });
            feather.replace(); // Re-initialize feather icons for new buttons
        }

        async function handleAddTransaction(event) {
            event.preventDefault();
            const newTransaction = {
                Fecha: transactionDateInput.value,
                Movimiento: transactionMovementSelect.value,
                Tipo: transactionTypeSelect.value,
                Descripcion: transactionDescriptionInput.value,
                Monto: parseFloat(transactionAmountInput.value)
            };

            const result = await postData('addTransaction', newTransaction);

            if (result.status === 'success') {
                showToast('Transacción añadida exitosamente.', 'success');
                addTransactionForm.reset();
                transactionDateInput.value = new Date().toISOString().split('T')[0]; // Reset date to today
                allTransactions.push(result.transaction); // Add new transaction to cache
                applyFilters(); // Re-render table
                updateDashboard(); // Update dashboard with new data
                loadPredefinedTypesForTransactionForm(); // Refresh types for new transaction
                activateTab('transactions'); // Switch to transactions tab
            }
        }

        function openEditTransactionModal(transaction) {
            document.getElementById('edit-transaction-id').value = transaction.ID;
            document.getElementById('edit-transaction-date').value = transaction.Fecha; // Date format should be YYYY-MM-DD
            document.getElementById('edit-transaction-movement').value = transaction.Movimiento;
            document.getElementById('edit-transaction-type').value = transaction.Tipo;
            document.getElementById('edit-transaction-description').value = transaction.Descripcion;
            document.getElementById('edit-transaction-amount').value = transaction.Monto;
            openModal(editTransactionModal);
        }

        async function handleEditTransactionSubmit(event) {
            event.preventDefault();
            const updatedTransaction = {
                ID: document.getElementById('edit-transaction-id').value,
                Fecha: document.getElementById('edit-transaction-date').value,
                Movimiento: document.getElementById('edit-transaction-movement').value,
                Tipo: document.getElementById('edit-transaction-type').value,
                Descripcion: document.getElementById('edit-transaction-description').value,
                Monto: parseFloat(document.getElementById('edit-transaction-amount').value)
            };

            const result = await postData('updateTransaction', updatedTransaction);

            if (result.status === 'success') {
                showToast('Transacción actualizada exitosamente.', 'success');
                closeModal(editTransactionModal);
                // Update cache
                const index = allTransactions.findIndex(t => t.ID === updatedTransaction.ID);
                if (index !== -1) {
                    allTransactions[index] = { ...allTransactions[index], ...updatedTransaction };
                }
                applyFilters(); // Re-render table
                updateDashboard(); // Update dashboard
            }
        }

        async function deleteTransaction(id) {
            if (!confirm('¿Está seguro de que desea eliminar esta transacción?')) {
                return;
            }
            const result = await postData('deleteTransaction', { id });
            if (result.status === 'success') {
                showToast('Transacción eliminada exitosamente.', 'success');
                allTransactions = allTransactions.filter(t => t.ID !== id); // Remove from cache
                applyFilters(); // Re-render table
                updateDashboard(); // Update dashboard
            }
        }

        // --- Tipos Predefinidos ---

        async function loadPredefinedTypes() {
            const data = await fetchData('getPredefinedTypes');
            if (data.status === 'success') {
                allPredefinedTypes = data.predefinedTypes;
                renderPredefinedTypesTable(allPredefinedTypes);
                // Also update the filter type select options
                populateFilterTypes(allPredefinedTypes);
            }
        }

        function renderPredefinedTypesTable(predefinedTypes) {
            predefinedTypesTableBody.innerHTML = '';
            if (predefinedTypes.length === 0) {
                noPredefinedTypesMessage.style.display = 'block';
                return;
            }
            noPredefinedTypesMessage.style.display = 'none';

            predefinedTypes.forEach(type => {
                const row = predefinedTypesTableBody.insertRow();
                row.insertCell().textContent = type.Movimiento;
                row.insertCell().textContent = type.Tipo;
                row.insertCell().textContent = type.DescripcionSugerida || '-';
                row.insertCell().textContent = formatCurrency(type.MontoSugerido || 0);

                const actionsCell = row.insertCell();
                actionsCell.classList.add('table-actions');

                const editButton = document.createElement('button');
                editButton.innerHTML = '<i data-feather="edit-2"></i>';
                editButton.classList.add('btn', 'btn-secondary', 'btn-icon', 'btn-icon-sm');
                editButton.title = 'Editar';
                editButton.addEventListener('click', () => openEditPredefinedModal(type));
                actionsCell.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.innerHTML = '<i data-feather="trash-2"></i>';
                deleteButton.classList.add('btn', 'btn-danger', 'btn-icon', 'btn-icon-sm');
                deleteButton.title = 'Eliminar';
                deleteButton.addEventListener('click', () => deletePredefinedType(type.Tipo, type.Movimiento));
                actionsCell.appendChild(deleteButton);
            });
            feather.replace();
        }

        function populateFilterTypes(predefinedTypes) {
            filterTypeSelect.innerHTML = '<option value="">Todos</option>'; // Keep "Todos"
            const uniqueTypes = [...new Set(predefinedTypes.map(t => t.Tipo))];
            uniqueTypes.sort().forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                filterTypeSelect.appendChild(option);
            });
            filterTypeSelect.value = currentFilters.type; // Restore previously selected filter
        }

        async function loadPredefinedTypesForTransactionForm() {
            const data = await fetchData('getPredefinedTypes');
            if (data.status === 'success') {
                allPredefinedTypes = data.predefinedTypes; // Update cache
                updateTransactionTypeSelect();
            }
        }

        function updateTransactionTypeSelect() {
            const selectedMovement = transactionMovementSelect.value;
            transactionTypeSelect.innerHTML = '<option value="">Seleccione...</option>';
            if (selectedMovement) {
                const filteredTypes = allPredefinedTypes.filter(type => type.Movimiento === selectedMovement);
                filteredTypes.sort((a, b) => a.Tipo.localeCompare(b.Tipo)).forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.Tipo;
                    option.textContent = type.Tipo;
                    transactionTypeSelect.appendChild(option);
                });
            } else {
                transactionTypeSelect.innerHTML = '<option value="">Seleccione movimiento primero...</option>';
            }
            transactionTypeSelect.value = ''; // Reset selected type
            transactionDescriptionInput.value = ''; // Clear description
            transactionAmountInput.value = ''; // Clear amount
        }

        function autoFillTransactionFields() {
            const selectedMovement = transactionMovementSelect.value;
            const selectedType = transactionTypeSelect.value;

            if (selectedMovement && selectedType) {
                const predefined = allPredefinedTypes.find(
                    p => p.Movimiento === selectedMovement && p.Tipo === selectedType
                );
                if (predefined) {
                    transactionDescriptionInput.value = predefined.DescripcionSugerida || '';
                    transactionAmountInput.value = predefined.MontoSugerido || '';
                } else {
                    transactionDescriptionInput.value = '';
                    transactionAmountInput.value = '';
                }
            } else {
                transactionDescriptionInput.value = '';
                transactionAmountInput.value = '';
            }
        }


        async function handleAddPredefinedType(event) {
            event.preventDefault();
            const newPredefined = {
                Movimiento: document.getElementById('add-predefined-movement').value,
                Tipo: document.getElementById('add-predefined-type').value,
                DescripcionSugerida: document.getElementById('add-predefined-description').value,
                MontoSugerido: parseFloat(document.getElementById('add-predefined-amount').value) || 0
            };

            const result = await postData('addPredefined', newPredefined);

            if (result.status === 'success') {
                showToast('Tipo predefinido añadido exitosamente.', 'success');
                closeModal(addPredefinedModal);
                addPredefinedForm.reset();
                allPredefinedTypes.push(newPredefined); // Add to cache
                loadPredefinedTypes(); // Re-render table and update filters
                loadPredefinedTypesForTransactionForm(); // Update transaction form types
            }
        }

        function openEditPredefinedModal(predefined) {
            document.getElementById('edit-predefined-original-type').value = predefined.Tipo;
            document.getElementById('edit-predefined-original-movement').value = predefined.Movimiento;
            document.getElementById('edit-predefined-movement').value = predefined.Movimiento;
            document.getElementById('edit-predefined-type').value = predefined.Tipo;
            document.getElementById('edit-predefined-description').value = predefined.DescripcionSugerida || '';
            document.getElementById('edit-predefined-amount').value = predefined.MontoSugerido || '';
            openModal(editPredefinedModal);
        }

        async function handleEditPredefinedSubmit(event) {
            event.preventDefault();
            const updatedPredefined = {
                originalType: document.getElementById('edit-predefined-original-type').value,
                originalMovement: document.getElementById('edit-predefined-original-movement').value,
                newMovement: document.getElementById('edit-predefined-movement').value,
                newType: document.getElementById('edit-predefined-type').value,
                newDescription: document.getElementById('edit-predefined-description').value,
                newAmount: parseFloat(document.getElementById('edit-predefined-amount').value) || 0
            };

            const result = await postData('updatePredefined', updatedPredefined);

            if (result.status === 'success') {
                showToast('Tipo predefinido actualizado exitosamente.', 'success');
                closeModal(editPredefinedModal);
                // Update cache
                const index = allPredefinedTypes.findIndex(
                    p => p.Tipo === updatedPredefined.originalType && p.Movimiento === updatedPredefined.originalMovement
                );
                if (index !== -1) {
                    allPredefinedTypes[index] = {
                        Movimiento: updatedPredefined.newMovement,
                        Tipo: updatedPredefined.newType,
                        DescripcionSugerida: updatedPredefined.newDescription,
                        MontoSugerido: updatedPredefined.newAmount
                    };
                }
                loadPredefinedTypes(); // Re-render table and update filters
                loadPredefinedTypesForTransactionForm(); // Update transaction form types
            }
        }

        async function deletePredefinedType(type, movement) {
            if (!confirm(`¿Está seguro de que desea eliminar el tipo predefinido "${type}" (${movement})?`)) {
                return;
            }
            const result = await postData('deletePredefined', { type, movement });
            if (result.status === 'success') {
                showToast('Tipo predefinido eliminado exitosamente.', 'success');
                allPredefinedTypes = allPredefinedTypes.filter(
                    p => !(p.Tipo === type && p.Movimiento === movement)
                ); // Remove from cache
                loadPredefinedTypes(); // Re-render table and update filters
                loadPredefinedTypesForTransactionForm(); // Update transaction form types
            }
        }


        // --- Inicialización y Event Listeners ---

        document.addEventListener('DOMContentLoaded', () => {
            feather.replace(); // Initialize feather icons on page load

            // Event listeners para autenticación
            loginForm.addEventListener('submit', handleLogin);
            logoutButton.addEventListener('click', handleLogout);

            // Event listeners para pestañas
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    activateTab(button.dataset.tab);
                });
            });

            // Event listeners para modales
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        closeModal(overlay);
                    }
                });
            });

            document.querySelectorAll('.modal-close-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const modalTargetId = e.currentTarget.dataset.modalTarget;
                    const modalElement = document.getElementById(modalTargetId);
                    if (modalElement) {
                        closeModal(modalElement);
                    }
                });
            });

            // Specific form submissions and button clicks
            addTransactionForm.addEventListener('submit', handleAddTransaction);
            addTransactionButtonTable.addEventListener('click', () => activateTab('add-transaction')); // Go to add transaction tab
            addPredefinedButton.addEventListener('click', openAddPredefinedModal); // Botón para abrir modal "Añadir Tipo"
            addPredefinedForm.addEventListener('submit', handleAddPredefinedType); // Formulario dentro del modal
            editTransactionForm.addEventListener('submit', handleEditTransactionSubmit);
            editPredefinedForm.addEventListener('submit', handleEditPredefinedSubmit);

            // Event listeners para auto-rellenado de transacción
            transactionMovementSelect.addEventListener('change', updateTransactionTypeSelect); // Update types when movement changes
            transactionTypeSelect.addEventListener('change', autoFillTransactionFields);

            // Set today's date as default for transaction date input
            transactionDateInput.value = new Date().toISOString().split('T')[0];

            // Event listeners para los filtros de transacciones
            applyFiltersButton.addEventListener('click', applyFilters);
            filterMonthSelect.addEventListener('change', applyFilters);
            filterTypeSelect.addEventListener('change', applyFilters);
            filterMovementSelect.addEventListener('change', applyFilters);
            filterKeywordsInput.addEventListener('input', applyFilters); // Aplica el filtro mientras el usuario escribe

            // Event listeners para controles del dashboard
            dashboardMonthSelect.addEventListener('change', updateDashboard);
            dashboardYearSelect.addEventListener('change', updateDashboard);
        });
    </script>
    <script src="https://unpkg.com/feather-icons"></script>
</body>
</html>
